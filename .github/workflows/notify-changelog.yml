name: Notify Discord on Master Push

on:
  push:
    branches:
      - master

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Extract latest changelog (bottom block)
        id: changelog
        run: |
          # Lấy tất cả dòng bắt đầu bằng "## [" và nhớ lại dòng cuối cùng
          last=$(grep -n "^## \[" CHANGELOG.md | tail -1 | cut -d: -f1)
          # Từ dòng đó đến EOF
          sed -n "${last},\$p" CHANGELOG.md > latest.log
          
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat latest.log >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Discord
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$(echo "${{ steps.changelog.outputs.content }}" | sed 's/"/\\"/g')\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
