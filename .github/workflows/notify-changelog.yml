name: Notify Changelog

on:
  push:
    branches:
      - master

jobs:
  changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract last changelog section
        id: changelog
        run: |
          # L·∫•y nguy√™n section changelog
          CONTENT=$(tac CHANGELOG.md | awk '/^## /{if (p) exit; p=1} p' | tac)
          
          # B·ªè d√≤ng ƒë·∫ßu ti√™n (version)
          CONTENT_BODY=$(echo "$CONTENT" | tail -n +2)
          
          echo "CONTENT_BODY<<EOF" >> $GITHUB_ENV
          echo "$CONTENT_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send to Discord
        run: |
          VERSION=$(echo "$CONTENT" | head -n1 | sed 's/^## //')
          
          MESSAGE="üéâ **New version released: $VERSION! Congratulations!**\n\n> ${CONTENT_BODY//$'\n'/$'\n> '}"
          
          ESCAPED_MESSAGE=$(jq -Rn --arg content "$MESSAGE" '{"content": $content}')
          
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$ESCAPED_MESSAGE" \
               ${{ secrets.DISCORD_WEBHOOK }}
