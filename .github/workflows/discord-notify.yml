name: Notify Discord on Master Push

on:
  push:
    branches:
      - master

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - uses: actions/checkout@v3

      # 2. Extract latest changelog (last block)
      - name: Extract latest changelog
        id: changelog
        run: |
          # Lấy số dòng bắt đầu của block changelog cuối cùng
          last=$(grep -n "^## \[" CHANGELOG.md | tail -1 | cut -d: -f1)
          # Lấy từ dòng đó đến hết file
          changelog=$(sed -n "${last},\$p" CHANGELOG.md)

          # Escape % để GitHub Output multi-line an toàn
          changelog=${changelog//'%'/'%%'}

          # Ghi ra output để bước sau dùng
          echo "content=$changelog" >> $GITHUB_OUTPUT

      # 3. Send to Discord
      - name: Send changelog to Discord
        run: |
          # Dùng code block Markdown để hiển thị đẹp trên Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"\`\`\`${{ steps.changelog.outputs.content }}\`\`\`\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
