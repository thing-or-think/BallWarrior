name: Notify Discord on Master Push

on:
  push:
    branches:
      - master

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Extract latest changelog (bottom block)
        id: changelog
        run: |
          # Lấy số dòng bắt đầu của block changelog cuối cùng
          last=$(grep -n "^## \[" CHANGELOG.md | tail -1 | cut -d: -f1)
          # Lấy từ dòng đó đến hết file
          sed -n "${last},\$p" CHANGELOG.md > latest.log

          # Ghi ra output cho bước sau
          {
            echo "content<<EOF"
            cat latest.log
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Send to Discord
        run: |
          # Gửi nội dung changelog dưới dạng code block để Discord hiển thị nguyên format
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"\`\`\`$(echo "${{ steps.changelog.outputs.content }}" | sed 's/"/\\"/g')\`\`\`\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
